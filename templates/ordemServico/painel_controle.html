{% extends 'ordemServico/base.html' %}
{% load static %}
{% block title %} Painel de controle {% endblock %}
{% block style %}
<style>
    .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-concluido {
        background-color: #a8d5ba; /* Verde pastel */
        color: #155724; /* Verde escuro para texto */
    }

    .status-em-andamento {
        background-color: #fff3cd; /* Amarelo pastel */
        color: #856404; /* Amarelo escuro para texto */
    }

    .status-em-espera {
        background-color: #f8d7da; /* Vermelho pastel */
        color: #721c24; /* Vermelho escuro para texto */
    }

    .status-cell {
        padding: 8px;
        text-align: center;
        border-radius: 4px;
    }


</style>
{% endblock %}

{% block content %}
<div class="content page-title mb-5 px-4" style="min-height: 80vh;">

    <div class="container">
        <h3 class="titulo-pagina">
            <i class="bi bi-graph-up" style="margin-right: 4px;"></i>
            Painel de controle
        </h3>

        <!-- Gráfico 1: Quantidade de serviços criados por mês -->
        <div class="mb-4" style="width: 100%; height: 40vh; display: flex; justify-content: center; align-items: center;">
            <canvas id="graficoServicosPorMes" style="max-width: 90%; height: 100%;"></canvas>
        </div>

        <!-- Container para os gráficos de status e vendas -->
        <div class="mb-4" style="display: flex; justify-content: space-between; align-items: center; width: 100%; height: 40vh;">
            <!-- Gráfico 2: Quantidade de serviços por status -->
            <div style="width: 40%; height: 100%; display: flex; justify-content: center; align-items: center;">
                <canvas id="graficoServicosPorStatus" style="max-width: 100%; height: 100%;"></canvas>
            </div>

            <!-- Gráfico 3: Valor de vendas por mês -->
            <div style="width: 58%; height: 100%; display: flex; justify-content: center; align-items: center;">
                <canvas id="graficoVendasPorMes" style="max-width: 100%; height: 100%;"></canvas>
            </div>
        </div>

        <h6 style="color: #78828B; font-weight: 400; font-size: 14px;" class="mb-2">
            Histórico de serviços:
        </h6>

        <div style="display: flex; align-items: center; gap: 10px;" class="mb-1">
            <!-- Campo de Pesquisa -->
            <input type="text" id="search-input" class="form-control w-50" placeholder="Pesquisar..." style=" padding: 0.5rem; font-size: 14px; background-color: var(--cinza-claro);">
        
            <!-- Botões de Filtro -->
            <button onclick="filterTable('concluída')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #28a745;
                        background-color: #f0fdf4;
                        color: #155724;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #28a745;">
                </span>
                Concluído
            </button>
        
            <button onclick="filterTable('em andamento')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #ffc107;
                        background-color: #fff8e1;
                        color: #856404;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #ffc107;">
                </span>
                Em andamento
            </button>
        
            <button onclick="filterTable('em espera')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #dc3545;
                        background-color: #fde2e4;
                        color: #721c24;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #dc3545;">
                </span>
                Em espera
            </button>
        
            <button onclick="filterTable('')" 
                    style="
                        display: inline-flex;
                        align-items: center;
                        padding: 8px 16px;
                        border-radius: 16px;
                        border: 1px solid #6c757d;
                        background-color: #f8f9fa;
                        color: #6c757d;
                        font-size: 12px;
                        cursor: pointer;
                        font-weight: bold;">
                <span style="
                        display: inline-block;
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        margin-right: 8px;
                        background-color: #6c757d;">
                </span>
                Todos
            </button>
        </div>

        <div class="tabela-painel-controle p-1" style="max-height: 50vh; overflow-y: auto;">
            
            <table class="table table-hover" id="data-table">
                <thead>
                    <tr 
                        style="font-size: 12px; text-align: center;">

                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem; border-top-left-radius: 12px; border-bottom-left-radius: 12px;">CLIENTE</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem;">SERVIÇO</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem;">RECEBIMENTO</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem;">CONCLUSÃO</th>
                        <th scope="col" style="background-color: var(--azul-principal); color: var(--cinza-claro); padding: 0.75rem; border-top-right-radius: 12px; border-bottom-right-radius: 12px;">STATUS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for servico in servicos %}
                    <tr id="servico-{{ servico.id }}"
                        data-status="{{ servico.get_status_display|lower }}" 
                        style="font-size: 12px; text-align: center; border-bottom: 3px solid var(--cinza-claro); cursor: pointer;" 
                        data-url="{% url 'servico' servico.id %}" 
                        onclick="window.location.href=this.getAttribute('data-url');">
                    
                        <td style="padding: 0.75rem;">{{ servico.ordem_servico.cliente.nome|truncatechars:40|upper }}</td>
                        <td>{{ servico.repositorio.nome|truncatechars:20|upper }}</td>
                        <td>{{ servico.ordem_servico.data_criacao|date:"d/m/Y" }}</td>
                        <td>
                            {% if servico.data_conclusao %}
                            {{ servico.data_conclusao|date:"d/m/Y" }}
                            {% else %}
                            NÃO CONCLUÍDO
                            {% endif %}
                        </td>
                        <td style="text-align: center;">
                            <span style="
                                display: inline-flex; 
                                align-items: center; 
                                padding: 4px 8px; 
                                border-radius: 16px; 
                                border: 1px solid 
                                    {% if servico.get_status_display|lower == 'concluída' %}#28a745{% endif %}
                                    {% if servico.get_status_display|lower == 'em andamento' %}#ffc107{% endif %}
                                    {% if servico.get_status_display|lower == 'em espera' %}#dc3545{% endif %};
                                background-color: 
                                    {% if servico.get_status_display|lower == 'concluída' %}#f0fdf4{% endif %}
                                    {% if servico.get_status_display|lower == 'em andamento' %}#fff8e1{% endif %}
                                    {% if servico.get_status_display|lower == 'em espera' %}#fde2e4{% endif %};
                                color: 
                                    {% if servico.get_status_display|lower == 'concluída' %}#155724{% endif %}
                                    {% if servico.get_status_display|lower == 'em andamento' %}#856404{% endif %}
                                    {% if servico.get_status_display|lower == 'em espera' %}#721c24{% endif %};
                            ">
                                <span style="
                                    display: inline-block; 
                                    width: 10px; 
                                    height: 10px; 
                                    border-radius: 50%; 
                                    margin-right: 8px; 
                                    background-color: 
                                        {% if servico.get_status_display|lower == 'concluída' %}#28a745{% endif %}
                                        {% if servico.get_status_display|lower == 'em andamento' %}#ffc107{% endif %}
                                        {% if servico.get_status_display|lower == 'em espera' %}#dc3545{% endif %};
                                ">
                                </span>
                                {{ servico.get_status_display|upper }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<!-- FILTRA A TABELA PELO NOME DO CLIENTE -->
<script>
    function filterTable() {
        // Obtém o valor digitado no campo de pesquisa
        let input = document.getElementById('search-input');
        let filter = input.value.toLowerCase();
        let table = document.getElementById('data-table');
        let tr = table.getElementsByTagName('tr');

        // Loop através das linhas da tabela (ignorando o cabeçalho)
        for (let i = 1; i < tr.length; i++) {  // Começa do índice 1 para ignorar o cabeçalho
            let tdArray = tr[i].getElementsByTagName('td');
            let found = false;

            // Verifica se algum dos campos (td) da linha corresponde ao filtro
            for (let j = 0; j < tdArray.length; j++) {
                if (tdArray[j]) {
                    let txtValue = tdArray[j].textContent || tdArray[j].innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }

            // Mostra ou oculta a linha com base na pesquisa
            if (found) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }
    }
</script>

<!-- FILTRA A TABELA PELO STATUS DO SERVIÇO -->
<script>
    function filterTable(status) {
        const rows = document.querySelectorAll('#data-table tbody tr');
        rows.forEach(row => {
            const rowStatus = row.getAttribute('data-status');
            if (status === '' || rowStatus === status) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Requisição para obter os dados
    fetch('/api/servicos-graficos/')
        .then(response => response.json())
        .then(data => {
            // Dados do gráfico de serviços criados por mês
            const labelsServicosPorMes = data.servicos_por_mes.map(item => item.mes);
            const dataServicosPorMes = data.servicos_por_mes.map(item => item.total);

            const ctx1 = document.getElementById('graficoServicosPorMes').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labelsServicosPorMes,
                    datasets: [{
                        label: 'Serviços Criados por Mês',
                        data: dataServicosPorMes,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Dados do gráfico de serviços por status
            const labelsServicosPorStatus = data.servicos_por_status.map(item => item.status);
            const dataServicosPorStatus = data.servicos_por_status.map(item => item.total);

            const ctx2 = document.getElementById('graficoServicosPorStatus').getContext('2d');
            new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: labelsServicosPorStatus,
                    datasets: [{
                        label: 'Serviços por Status',
                        data: dataServicosPorStatus,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Dados do gráfico de vendas por mês
            const labelsVendasPorMes = data.vendas_por_mes.map(item => item.mes);
            const dataVendasPorMes = data.vendas_por_mes.map(item => item.total_vendas);

            const ctx3 = document.getElementById('graficoVendasPorMes').getContext('2d');
            new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: labelsVendasPorMes,
                    datasets: [{
                        label: 'Valor de Vendas por Mês',
                        data: dataVendasPorMes,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Erro ao carregar os dados dos gráficos:', error));
</script>


{% endblock %}